[tox]
requires = tox>=4
env_list =
    backend
    frontend
    dev
skipsdist = true

[testenv]
skip_install = true
allowlist_externals =
    uv
    bash
passenv =
    BACKEND_PORT
    FRONTEND_PORT
    API_BASE_URL

# Run backend with reload
[testenv:backend]
setenv =
    BACKEND_PORT = {env:BACKEND_PORT:9000}
commands =
    bash -lc "uv run uvicorn src.backend.main:app --reload --port $BACKEND_PORT"

# Run frontend with reload
[testenv:frontend]
setenv =
    FRONTEND_PORT = {env:FRONTEND_PORT:9001}
    BACKEND_PORT = {env:BACKEND_PORT:9000}
    API_BASE_URL  = http://localhost:{env:BACKEND_PORT:9000}
commands =
    bash -lc "API_BASE_URL=$API_BASE_URL uv run chainlit run src/frontend/app.py --watch --port $FRONTEND_PORT"

# Run both services for development
[testenv:dev]
setenv =
    FRONTEND_PORT = {env:FRONTEND_PORT:9001}
    BACKEND_PORT = {env:BACKEND_PORT:9000}
    API_BASE_URL  = http://localhost:{env:BACKEND_PORT:9000}
commands =
    bash -lc "uv run uvicorn src.backend.main:app --reload --port $BACKEND_PORT & uv run chainlit run src/frontend/app.py --watch --port $FRONTEND_PORT & wait"