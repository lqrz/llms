[tox]
requires = tox>=4
env_list =
    backend
    frontend
    dev
    tf-init
    tf-plan
    tf-apply
    aws-secrets-put
skipsdist = true

[testenv]
skip_install = true
allowlist_externals =
    uv
    bash
    terraform
    aws
passenv =
    BACKEND_PORT
    FRONTEND_PORT
    API_BASE_URL

# Run backend with reload
[testenv:backend]
setenv =
    BACKEND_PORT = {env:BACKEND_PORT:9000}
commands =
    bash -lc "uv run uvicorn src.backend.main:app --reload --port $BACKEND_PORT"

# Run frontend with reload
[testenv:frontend]
setenv =
    FRONTEND_PORT = {env:FRONTEND_PORT:9001}
    BACKEND_PORT = {env:BACKEND_PORT:9000}
    API_BASE_URL  = http://localhost:{env:BACKEND_PORT:9000}
commands =
    bash -lc "API_BASE_URL=$API_BASE_URL uv run uvicorn src.frontend.main:app --host 0.0.0.0 --port $FRONTEND_PORT"

# Run both services for development
[testenv:dev]
setenv =
    FRONTEND_PORT = {env:FRONTEND_PORT:9001}
    BACKEND_PORT = {env:BACKEND_PORT:9000}
    API_BASE_URL  = http://localhost:{env:BACKEND_PORT:9000}
commands =
    bash -lc "uv run uvicorn src.backend.main:app --reload --port $BACKEND_PORT & uv run chainlit run src/frontend/app.py --watch --port $FRONTEND_PORT & wait"
    
# ----------------------------
# Terraform
# ----------------------------

[testenv:tf-init]
description = terraform init (requires .env)
commands =
    bash -euc 'test -f .env || { echo "Missing .env"; exit 1; }; set -a; . ./.env; set +a; terraform -chdir=terraform init'

[testenv:tf-plan]
description = terraform plan (requires .env)
commands =
    bash -euc 'test -f .env || { echo "Missing .env"; exit 1; }; set -a; . ./.env; set +a; terraform -chdir=terraform plan'

[testenv:tf-apply]
description = terraform apply (requires .env)
commands =
    bash -euc 'test -f .env || { echo "Missing .env"; exit 1; }; set -a; . ./.env; set +a; terraform -chdir=terraform apply'

# ----------------------------
# AWS Secrets
# ----------------------------

[testenv:aws-secrets-put]
description = put secret value into AWS Secrets Manager from keys in .env
commands =
    bash -euc '
      test -f .env || { echo "Missing .env"; exit 1; }
      set -a; . ./.env; set +a
      : "${AWS_PROJECT:?AWS_PROJECT is missing in .env}"
      : "${AWS_REGION:?AWS_REGION is missing in .env}"
      SECRET_JSON="$(python -c '"'"'import os, json; keys=["OPENAI_API_KEY","GEMINI_API_KEY","LANGSMITH_API_KEY"]; print(json.dumps({k: os.environ.get(k, "") for k in keys}))'"'"')"
      echo "Putting secret value into Secrets Manager: ${AWS_PROJECT} (region=${AWS_REGION})"
      aws secretsmanager put-secret-value --region "${AWS_REGION}" --secret-id "${AWS_PROJECT}" --secret-string "${SECRET_JSON}"
    '
