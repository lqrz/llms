# Backend Dockerfile - FastAPI service
FROM python:3.12-slim

WORKDIR /app

# Install system dependencies (curl for healthcheck)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv package manager
RUN pip install --no-cache-dir "uv==0.10.2"

# Copy dependency files
COPY pyproject.toml uv.lock ./

# 1) Cacheable layer: ONLY third-party deps
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev --extra backend --no-install-project

# Copy source code
COPY src/ ./src/

# 3) Fast layer: install just your project into the existing env
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev --extra backend

# ---- Runtime-configurable env var (with default) ----
ENV PORT=8000 \
    DEFAULT_LLM_PROVIDER=OPENAI \
    DEFAULT_LLM_MODEL=gpt-4o-mini \
    DEFAULT_EMBEDDING_PROVIDER=openai \
    DEFAULT_EMBEDDING_MODEL=text-embedding-3-small \
    WEAVIATE_URL=http://localhost:8081 \
    HYBRID_SEARCH_ALPHA=0.5 \
    RETRIEVAL_TOP_K=20 \
    RERANK_TOP_N=5 \
    RERANKER_TYPE=local \
    LOCAL_RERANKER_MODEL=cross-encoder/ms-marco-MiniLM-L-12-v2

# Expose backend port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD sh -c 'curl -fsS "http://localhost:${PORT}/health" || exit 1'

# Run backend with uvicorn
CMD ["sh", "-c", "uv run uvicorn src.backend.main:app --host 0.0.0.0 --port ${PORT}"]